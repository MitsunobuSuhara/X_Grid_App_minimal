# X_Grid - 平均集材距離計算システム 2.0

X_Gridは、森林施業における「平均集材距離」をグリッド法を用いて高精度かつ効率的に計算するためのデスクトップアプリケーションです。

## 概要

このシステムは、GISデータ（Shapefile, GeoPackage, ZIP形式のShapefile）を読み込み、指定された集材区域と土場の位置関係から平均集材距離を自動的に算出します。

## 主な機能

- **GISレイヤのサポート**: Shapefile (.shp), GeoPackage (.gpkg), ShapefileのZIP圧縮ファイルを直接ドラッグ＆ドロップで読み込み可能。
- **グリッド法による計算**: 区域を一定サイズのセルに分割し、各セルから土場までの距離の平均を算出（50%面積ルール採用）。
- **柔軟な計算モード**:
  - **区域全体計算**: 単一の土場に対する区域全体の距離計算。
  - **分割計算**: 区域を分割線で分け、それぞれの土場・入口に対する計算と、その全体の加重平均を算出。
- **外部土場対応**: 土場が区域外にある場合、区域入口（結節点）を経由した距離計算が可能。
- **インタラクティブな操作**: 地図上でのクリックによる土場指定、分割線の描画、テキスト注釈の追加。
- **レポート出力**: 計算結果を詳細なExcel総括表、および図面付きのPDFとしてエクスポート。

## インストールと実行

### システム要件
- OS: Windows (推奨)
- Python 3.9以上

### セットアップ
1. リポジトリをクローンまたはダウンロードします。
2. 必要なライブラリをインストールします。
   ```bash
   pip install PyQt6 fiona shapely PyPDF2 openpyxl
   ```
3. `main.py` を実行します。
   ```bash
   python main.py
   ```

## 使い方（基本ワークフロー）

1. **データの読み込み**: 計算対象となるポリゴンを含むGISファイルを、画面左のリストまたは地図エリアにドラッグ＆ドロップします。
2. **計算対象の設定**: 「レイヤ管理」で、計算に使用するレイヤにチェックを入れます。
3. **計算開始**: 「区域全体で計算」または「区域を分割して計算」を選択します。
4. **土場/入口の指定**: 操作ガイドに従い、地図上のセルを左クリックして土場（または区域の入口）を指定します。
5. **計算実行**: 画面上部の「計算を実行」ボタンを押すと、グリッドが描画され結果が表示されます。
6. **エクスポート**: 「Excel出力」で詳細な数値データを、「PDFエクスポート」で計算結果を含む図面を出力します。

## 計算ロジックについて

当システムでは以下のルールに基づき計算を行っています。

- **50%面積ルール**: 1つのグリッドセルの面積のうち、50%以上が区域に含まれる場合に、そのセルを計算対象（1単位）としてカウントします。
- **平均集材距離 (L)**:
  - `L = (Σ 距離) / セル数 * セル定数(k)`
  - ここで距離は、各セルの中心から土場までのマンハッタン距離（格子距離）として計算されます。
- **加重平均**: 区域を分割した場合、各区域のセル数（面積）に基づく加重平均として全体の平均距離を算出します。

## 開発・ライセンス

- 開発: Mitsunobu Suhara
- ライセンス: MIT License (または適宜指定)
